{"id":"7145d2fb-90b3-4ba2-ad90-a76bff3aef71","name":"motortown-recalculo","description":"","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"preExecutionSqlSentences":[],"postExecutionSqlSentences":[],"addAllUploadedPlugins":true,"mesosConstraint":"","mesosConstraintOperator":"CLUSTER","parametersLists":["Environment"],"parametersUsed":["Environment.POSTGRES_URL","Global.SPARK_DRIVER_CORES","Global.SPARK_DRIVER_JAVA_OPTIONS","Global.SPARK_DRIVER_MEMORY","Global.SPARK_EXECUTOR_CORES","Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS","Global.SPARK_LOCALITY_WAIT","Global.SPARK_LOCAL_PATH","Global.SPARK_MEMORY_FRACTION","Global.SPARK_TASK_MAX_FAILURES","MOTORTOWN_SCHEMA","POSTGRES_URL"],"udfsToRegister":[],"udafsToRegister":[],"mesosRole":"","marathonDeploymentSettings":{"gracePeriodSeconds":"","intervalSeconds":"","timeoutSeconds":"","maxConsecutiveFailures":"","forcePullImage":false,"privileged":false,"userEnvVariables":[],"userLabels":[],"logLevel":""}},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"mesos://zk://master.mesos:2181/mesos","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{Global.SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"4","executorMemory":"4G","executorCores":"{{{Global.SPARK_EXECUTOR_CORES}}}","driverCores":"{{{Global.SPARK_DRIVER_CORES}}}","driverMemory":"{{{Global.SPARK_DRIVER_MEMORY}}}","mesosExtraCores":"","localityWait":"{{{Global.SPARK_LOCALITY_WAIT}}}","taskMaxFailures":"{{{Global.SPARK_TASK_MAX_FAILURES}}}","sparkMemoryFraction":"{{{Global.SPARK_MEMORY_FRACTION}}}","sparkParallelism":""},"sparkHistoryServerConf":{"enableHistoryServerMonitoring":false,"sparkHistoryServerEventLogRotateEnable":false,"sparkHistoryServerEventLogRotateNum":"9","sparkHistoryServerEventLogRotateSize":"512"},"userSparkConf":[],"coarse":true,"sparkUser":"","sparkLocalDir":"{{{Global.SPARK_LOCAL_PATH}}}","sparkKryoSerialization":false,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{Global.SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[{"outputStepName":"Postgres_validation","omitSaveErrors":true,"addRedirectDate":false}],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"Postgres_1","stepType":"Output","className":"PostgresOutputStep","classPrettyName":"Postgres","arity":["NullaryToNullary","NaryToNullary"],"writer":{"saveMode":"Append"},"uiConfiguration":{"position":{"x":3077.2780020597247,"y":2091.5365564642375}},"configuration":{"errorSink":false,"url":"{{{Environment.POSTGRES_URL}}}","postgresSaveMode":"STATEMENT","batchsize":"1000","isolationLevel":"READ_UNCOMMITTED","failFast":true,"tlsEnabled":true,"driver":"","schemaFromDatabase":false,"saveOptions":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[]},{"name":"Attributes","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"/*\n\t,case when disponibilidad='__EMPTY__VALUE__' or Estado ='Desactivado' then 0 \n\t\telse 1 end as product_online\n\t*/","uiConfiguration":{"position":{"x":2628.8509119698065,"y":809.2790856210743}},"configuration":{"sql":"select CodInterno, EAN, Matricula, DescripcionAlias,Descripcion02,Categoria\n\t,Atributo03,Atributo04,Atributo05\n\t,linkImgL,linkImgM,linkImgS\n\t,ServiciosObligatorios,ServiciosOpcionales\n\t,ActivoExterno,Precio\n\t,titulo_neumatico_matricula,codigo_neumatico_matricula\n\t,case when disponibilidad='__EMPTY__VALUE__' or Estado ='Desactivado' then 0 \n\t\telse 1 end as product_online\n ,originalfile\n ,isMatricula\n ,runflat_text\n ,Atributo09,Atributo06,Atributo08,Atributo07\n ,Atributo16,Atributo10,GrupoProducto,disponibilidad,orden_disponibilidad\n ,disponibilidad_matricula,orden_disponibilidad_matricula,availability_date,orden_alfabetico\n ,concat (\n 'cai=103293,'\n ,'color=red,'\n ,'label_icon_1=C,'\n ,'label_icon_2=A,'\n ,'label_icon_3=1,'\n ,'label_icon_4=68,'\n ,'on_hover=png,'\n ,'tyre_group=Marca líder,'\n ,'tyre_store=Motortown,'\n ) as  additional_attributes \nfrom AddDisponibilidadMatricula\n ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductsFields","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"concat('\"', coalesce(additional_attributes,''), '\"') as  additional_attributes ,\n","uiConfiguration":{"position":{"x":3075.572326398451,"y":811.5964081339473}},"configuration":{"sql":"Select \nconcat('\"', coalesce(CodInterno,''), '\"') as  sku ,\nconcat('\"', coalesce('',''), '\"') as  store_view_code,\nconcat('\"', coalesce('Neumaticos',''), '\"') as  attribute_set_code ,\nconcat('\"', coalesce('simple',''), '\"') as  product_type ,\nconcat('\"', coalesce('Default Category/Neumáticos',''), '\"') as  categories ,\nconcat('\"', coalesce('base',''), '\"') as  product_websites ,\nconcat('\"', coalesce(titulo_neumatico_matricula,''), '\"') as  name ,\nconcat('\"', coalesce(titulo_neumatico_matricula,''), '\"') as  description ,\nconcat('\"', coalesce('',''), '\"') as  short_description ,\nconcat('\"', coalesce('',''), '\"') as  weight ,\nconcat('\"', coalesce(product_online,''), '\"') as  product_online ,\nconcat('\"', coalesce('Taxable Goods',''), '\"') as  tax_class_name ,\nconcat('\"', coalesce('Catálogo, Búsqueda',''), '\"') as  visibility ,\nconcat('\"', coalesce(Precio,''), '\"') as  price,\nconcat('\"', coalesce('',''), '\"') as  special_price ,\nconcat('\"', coalesce('',''), '\"') as  special_price_from_date ,\nconcat('\"', coalesce('',''), '\"') as  special_price_to_date ,\nconcat('\"', coalesce(CodInterno,''), '\"') as  url_key ,\nconcat('\"', coalesce('',''), '\"') as  meta_title ,\nconcat('\"', coalesce('',''), '\"') as  meta_keywords ,\nconcat('\"', coalesce('',''), '\"') as  meta_description ,\nconcat('\"', coalesce(linkImgL,''), '\"') as  base_image ,  /*substr(linkImgL,-17,17)*/\nconcat('\"', coalesce('',''), '\"') as  base_image_label , \nconcat('\"', coalesce(linkImgL,''), '\"') as  small_image , \nconcat('\"', coalesce('',''), '\"') as  small_image_label , \nconcat('\"', coalesce(linkImgL,''), '\"') as  thumbnail_image , \nconcat('\"', coalesce('',''), '\"') as  thumbnail_image_label , \nconcat('\"', coalesce('',''), '\"') as  swatch_image , \nconcat('\"', coalesce('',''), '\"') as  swatch_image_label , \nconcat('\"', coalesce('',''), '\"') as  created_at ,\nconcat('\"', coalesce('',''), '\"') as  updated_at ,\nconcat('\"', coalesce('',''), '\"') as  new_from_date ,\nconcat('\"', coalesce('',''), '\"') as  new_to_date ,\nconcat('\"', coalesce('Block after Info Column',''), '\"') as  display_product_options_in ,\nconcat('\"', coalesce('',''), '\"') as  map_price ,\nconcat('\"', coalesce('',''), '\"') as  msrp_price ,\nconcat('\"', coalesce('',''), '\"') as  map_enabled ,\nconcat('\"', coalesce('',''), '\"') as  gift_message_available ,\nconcat('\"', coalesce('',''), '\"') as  custom_design ,\nconcat('\"', coalesce('',''), '\"') as  custom_design_from ,\nconcat('\"', coalesce('',''), '\"') as  custom_design_to ,\nconcat('\"', coalesce('',''), '\"') as  custom_layout_update ,\nconcat('\"', coalesce('',''), '\"') as  page_layout ,\nconcat('\"', coalesce('',''), '\"') as  product_options_container ,\nconcat('\"', coalesce('',''), '\"') as  msrp_display_actual_price_type ,\nconcat('\"', coalesce('',''), '\"') as  country_of_manufacture ,\nconcat('\"', coalesce(additional_attributes,''), '\"') as  additional_attributes ,\nconcat('\"', coalesce(isMatricula,''), '\"') as  is_matricula ,\nconcat('\"', coalesce(runflat_text,''), '\"') as  runflat ,\nconcat('\"', coalesce(Atributo09,''), '\"') as  speed_index ,\nconcat('\"', coalesce(Atributo06,''), '\"') as  diameter ,\nconcat('\"', coalesce(Atributo08,''), '\"') as  height ,\nconcat('\"', coalesce(Atributo07,''), '\"') as  width ,\nconcat('\"', coalesce(ActivoExterno,''), '\"') as  activoexterno ,\nconcat('\"', coalesce(EAN,''), '\"') as  ean ,\nconcat('\"', coalesce(Atributo16,''), '\"') as  homologation ,\nconcat('\"', coalesce(lpad(Atributo10,3,'0'),''), '\"') as  load_index ,\nconcat('\"', coalesce(Atributo03,''), '\"') as  manufacturer ,\nconcat('\"', coalesce(Matricula,''), '\"') as  matricula ,\nconcat('\"', coalesce(Atributo05,''), '\"') as  season ,\nconcat('\"', coalesce(Atributo04,''), '\"') as  tyre_model ,\nconcat('\"', coalesce(GrupoProducto,''), '\"') as  vehicle_type  ,\nconcat('\"', coalesce(disponibilidad,''), '\"') as  availability ,\nconcat('\"', coalesce(orden_disponibilidad,''), '\"') as  availability_order ,\nconcat('\"', coalesce(disponibilidad_matricula,''), '\"') as  availability_matricula ,\nconcat('\"', coalesce(orden_disponibilidad_matricula,''), '\"') as  availability_order_matricula ,\nconcat('\"', coalesce(availability_date,''), '\"') as  availability_date ,\nconcat('\"', coalesce(orden_alfabetico,''), '\"') as  alphabetical_order ,\nconcat('\"', coalesce(ecotasa_attribute,''), '\"') as  ecotasa ,\nconcat('\"', coalesce('0',''), '\"') as  qty ,\nconcat('\"', coalesce('0',''), '\"') as  out_of_stock_qty ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_min_qty ,\nconcat('\"', coalesce('0',''), '\"') as  is_qty_decimal ,\nconcat('\"', coalesce('0',''), '\"') as  allow_backorders ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_backorders ,\nconcat('\"', coalesce('1',''), '\"') as  min_cart_qty ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_min_sale_qty ,\nconcat('\"', coalesce('5',''), '\"') as  max_cart_qty ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_max_sale_qty ,\nconcat('\"', coalesce('0',''), '\"') as  is_in_stock ,\nconcat('\"', coalesce('',''), '\"') as  notify_on_stock_below ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_notify_stock_qty ,\nconcat('\"', coalesce('0',''), '\"') as  manage_stock ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_manage_stock ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_qty_increments ,\nconcat('\"', coalesce('0',''), '\"') as  qty_increments ,\nconcat('\"', coalesce('0',''), '\"') as  use_config_enable_qty_inc ,\nconcat('\"', coalesce('0',''), '\"') as  enable_qty_increments ,\nconcat('\"', coalesce('0',''), '\"') as  is_decimal_divided ,\nconcat('\"', coalesce('',''), '\"') as  website_id ,\nconcat('\"', coalesce('',''), '\"') as  related_skus ,\nconcat('\"', coalesce('',''), '\"') as  related_position ,\nconcat('\"', coalesce('',''), '\"') as  crosssell_skus ,\nconcat('\"', coalesce('',''), '\"') as  crosssell_position ,\nconcat('\"', coalesce('',''), '\"') as  upsell_skus ,\nconcat('\"', coalesce('',''), '\"') as  upsell_position ,\nconcat('\"', coalesce('',''), '\"') as  additional_images ,\nconcat('\"', coalesce('',''), '\"') as  additional_image_labels ,\nconcat('\"', coalesce('',''), '\"') as  hide_from_product_page ,\nconcat('\"', coalesce(custom_options,''), '\"') as  custom_options ,\nconcat('\"', coalesce('',''), '\"') as  bundle_price_type ,\nconcat('\"', coalesce('',''), '\"') as  bundle_sku_type ,\nconcat('\"', coalesce('',''), '\"') as  bundle_price_view ,\nconcat('\"', coalesce('',''), '\"') as  bundle_weight_type ,\nconcat('\"', coalesce('',''), '\"') as  bundle_values ,\nconcat('\"', coalesce('',''), '\"') as  bundle_shipment_type ,\nconcat('\"', coalesce('',''), '\"') as  configurable_variations ,\nconcat('\"', coalesce('',''), '\"') as  configurable_variation_labels ,\nconcat('\"', coalesce('',''), '\"') as  associated_skus ,\noriginalfile\nfrom AttributesAndOptions","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"MagentoCsvProducts","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"motortown.magentocsvproducts4","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":3075.8550417656115,"y":992.3738228418614}},"configuration":{"sql":"select concat_ws\n(',',\nsku ,\nstore_view_code ,\nattribute_set_code,\nproduct_type ,\ncategories ,\nproduct_websites ,\nname ,\ndescription ,\nshort_description ,\nweight ,\nproduct_online ,\ntax_class_name ,\nvisibility ,\nprice ,\nspecial_price ,\nspecial_price_from_date ,\nspecial_price_to_date ,\nurl_key ,\nmeta_title ,\nmeta_keywords ,\nmeta_description ,\nbase_image ,\nbase_image_label ,\nsmall_image ,\nsmall_image_label ,\nthumbnail_image ,\nthumbnail_image_label ,\nswatch_image ,\nswatch_image_label ,\ncreated_at ,\nupdated_at ,\nnew_from_date ,\nnew_to_date ,\ndisplay_product_options_in ,\nmap_price ,\nmsrp_price ,\nmap_enabled ,\ngift_message_available ,\ncustom_design ,\ncustom_design_from ,\ncustom_design_to ,\ncustom_layout_update ,\npage_layout ,\nproduct_options_container ,\nmsrp_display_actual_price_type ,\ncountry_of_manufacture ,\nadditional_attributes ,\nis_matricula ,\nrunflat ,\nspeed_index ,\ndiameter ,\nheight ,\nwidth ,\nactivoexterno , ean, homologation, load_index,manufacturer,matricula,season,tyre_model,\nvehicle_type, availability,availability_order,availability_matricula,\navailability_order_matricula,availability_date, alphabetical_order,ecotasa,\nqty ,\nout_of_stock_qty ,\nuse_config_min_qty ,\nis_qty_decimal ,\nallow_backorders ,\nuse_config_backorders ,\nmin_cart_qty ,\nuse_config_min_sale_qty ,\nmax_cart_qty ,\nuse_config_max_sale_qty ,\nis_in_stock ,\nnotify_on_stock_below ,\nuse_config_notify_stock_qty ,\nmanage_stock ,\nuse_config_manage_stock ,\nuse_config_qty_increments ,\nqty_increments ,\nuse_config_enable_qty_inc ,\nenable_qty_increments ,\nis_decimal_divided ,\nwebsite_id ,\nrelated_skus ,\nrelated_position ,\ncrosssell_skus ,\ncrosssell_position ,\nupsell_skus ,\nupsell_position ,\nadditional_images ,\nadditional_image_labels ,\nhide_from_product_page ,\ncustom_options ,\nbundle_price_type ,\nbundle_sku_type ,\nbundle_price_view ,\nbundle_weight_type ,\nbundle_values ,\nbundle_shipment_type ,\nconfigurable_variations ,\nconfigurable_variation_labels ,\nassociated_skus \n ) as csv, originalfile\n from \n ProductsFields","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosOrden","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Añadimos campo calculado ordenacion alfabetica a productos","uiConfiguration":{"position":{"x":805.8169978028673,"y":778.4987145344863}},"configuration":{"sql":"select *,Precio as pvp, Precio as pvp_promocionado,\n case \n when Upper(Trim(Atributo03)) in ('MOTORTOWN','AURGI') then 1\n when Upper(Trim(Atributo03)) = '1PRECIO' then 3\n else 2 \n end as orden_alfabetico\n  from Products_OK \n   where Categoria='NEUMATICOS'","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosTemporalidad","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Añadimos campo calculados codigo y titulo de producto, con el formateo que nos pide aurgi","uiConfiguration":{"position":{"x":1051.429967306908,"y":780.0511092767754}},"configuration":{"sql":"select *,\ncase\nwhen Atributo05 = 'I' then\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ', 'Invierno')\nwhen Atributo05 = 'T' then\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ', '4 Estaciones')\nelse\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ')\nend as titulo_temp,\ncase\nwhen Atributo05 = 'I' then\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ', Atributo04,' ', Atributo16, 'Invierno')\nwhen Atributo05 = 'T' then\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ', Atributo04,' ', Atributo16, '4 Estaciones')\nelse\nconcat('NEUMATICO ', Atributo03,' ', Atributo07, '/', Atributo08, ' R', Atributo06, ' ', Atributo10, 'V ', Atributo04,' ', Atributo16)\nend as codigo_temp\n from ProductosOrden","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosCalc","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Añadimos si es  Runflat en el código y título calculados del producto","uiConfiguration":{"position":{"x":1278.4892367714062,"y":779.460901423254}},"configuration":{"sql":"select *,\ncase\nwhen Atributo15 = 'R' then\nconcat(titulo_temp, ' ', Atributo15)\nelse\ntitulo_temp\nend as titulo_neumatico_matricula,\ncase\nwhen Atributo15 = 'R' then\nconcat(codigo_temp, ' ', Atributo15)\nelse\ncodigo_temp\nend as codigo_neumatico_matricula,\ncase\nwhen Atributo15='R' then 'yes'\nelse 'no'\nend as runflat_text\nfrom ProductosTemporalidad","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductServices","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Generamos una fila para cada servicio obligatorio de ese producto (identificado por EAN) para poder tratarlos individualmente","uiConfiguration":{"position":{"x":1095.4946802307677,"y":73.24947120403519}},"configuration":{"sql":"select EAN,explode(split(ServiciosObligatorios,\",\")) as product_services\n from ProductosIngestados \n where Categoria='NEUMATICOS'","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Services","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Definimos la plantilla del campo servicios obligatorios del csv destino, rellenando ya el calculation per unit segun servicio","uiConfiguration":{"position":{"x":1101.3580306563322,"y":192.48123749930863}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,coalesce(Atributo05,'0') as Atributo05,\n case when instr(DescripcionAlias,'PERMUTACION') > 0 then \n \t'name=Servicios Obligatorios,type=multiple,required=1,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=2'\n when instr(DescripcionAlias,'PARALE') > 0 then \n \t'name=Servicios Obligatorios,type=multiple,required=1,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=1'\n else \n \t'name=Servicios Obligatorios,type=multiple,required=1,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=0'\n end as cadena\n from DistinctServices\n where Categoria='SERVICIOS'","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesSKU","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla anterior le añadimos el codigo interno SKU","uiConfiguration":{"position":{"x":1313.749883813922,"y":192.8147766146348}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio, Atributo05,\nregexp_replace(\n\tcadena,'montaje',CodInterno) as cadena2\nfrom Services","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesDescription","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla la descripcion del servicio","uiConfiguration":{"position":{"x":1519.4060762084825,"y":194.00390284783407}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,Atributo05, \nregexp_replace(\n\tcadena2,'Montaje',DescripcionAlias) as cadena3\nfrom ServicesSKU","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesPrice","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla el precio, cambiando comas por puntos, que es el formato de moneda en magento","uiConfiguration":{"position":{"x":1720.2801606811388,"y":192.82346003777548}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio, Atributo05,\nregexp_replace(\n\tcadena3,'8.0000',cast(format_number(cast(regexp_replace(Precio,',','.') as double),2) as String)) as cadena4\nfrom ServicesDescription","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProdServicesJOIN","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"prodservicesjoin3","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Unimos filas individuales por servicio del producto con la plantilla que hemos generado del campo servicios obligatorios del csv","uiConfiguration":{"position":{"x":2115.280605354041,"y":70.3968982083604}},"configuration":{"sql":"select  a.EAN, b.custom_options,b.DescripcionAlias,b.Precio from ProductServices a\njoin ServicesTime b\n on a.product_services=b.CodInterno\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CustomOptions","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"customoptions2","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Juntamos y formateamos como cadena separada por el caracter | las filas de servicios opcionales y obligatorios, es el formato aceptado por magento en importacion csv","uiConfiguration":{"position":{"x":2593.1148821887055,"y":396.70697603141457}},"configuration":{"sql":"select EAN, concat_ws(\"|\",collect_list(custom_options)) as custom_options  \nfrom UnionServices \n  group by EAN","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"DistinctServices","stepType":"Transformation","className":"DistinctTransformStep","classPrettyName":"Distinct","arity":["UnaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Eliminamos filas de servicios duplicadas si las hubiera","uiConfiguration":{"position":{"x":1099.4789086603278,"y":330.3308007495607}},"configuration":{"partitions":"","inputSchemas":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"AttributesAndOptions","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":2871.929217914155,"y":813.4704480012755}},"configuration":{"sql":"select \na.CodInterno, a.EAN, a.Matricula, a.DescripcionAlias, a.Descripcion02, a.Categoria\n\t,a.Atributo03,a.Atributo04,a.Atributo05\n\t,a.linkImgL,a.linkImgM,a.linkImgS\n\t,a.ServiciosObligatorios,a.ServiciosOpcionales\n\t,a.ActivoExterno,a.Precio\n\t,a.orden_alfabetico,a.titulo_neumatico_matricula,a.codigo_neumatico_matricula\n\t,a.product_online,a.originalfile\n\t,a.isMatricula,a.runflat_text,a.Atributo09\n\t,a.Atributo06,a.Atributo08,a.Atributo07,a.Atributo16,a.Atributo10\n\t,a.GrupoProducto,a.disponibilidad,a.orden_disponibilidad,a.disponibilidad_matricula\n\t,a.orden_disponibilidad_matricula,a.availability_date,b.ecotasa_attribute as ecotasa_attribute\n , additional_attributes , b.custom_options\n from Attributes a \n join OptionsJoinsEcotasa b \n  on a.EAN=b.EAN","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesOpc","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Definimos la plantilla del campo servicios opcionales del csv destino, rellenando ya el calculation per unit segun servicio","uiConfiguration":{"position":{"x":1099.0809173097318,"y":466.9267503334677}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,coalesce(Atributo05,'0') as Atributo05,\n case when instr(DescripcionAlias,'PERMUTACION') > 0 then \n \t'name=Servicios Opcionales,type=multiple,required=0,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=2'\n when instr(DescripcionAlias,'PARALE') > 0 then \n \t'name=Servicios Opcionales,type=multiple,required=0,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=1'\n else \n \t'name=Servicios Opcionales,type=multiple,required=0,price=8.0000,price_type=fixed,sku=montaje,file_extension=,image_size_x=0,image_size_y=0,option_title=Montaje,time=10,calculation_per_unit=0'\n end as cadena\n from DistinctServices\n where Categoria='SERVICIOS'","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesOpcSKU","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla anterior le añadimos el codigo interno SKU","uiConfiguration":{"position":{"x":1316.2121503501342,"y":467.2603047075829}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,Atributo05,\nregexp_replace(\n\tcadena,'montaje',CodInterno) as cadena2\nfrom ServicesOpc","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesOpcDescription","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla la descripcion del servicio","uiConfiguration":{"position":{"x":1524.6991532915697,"y":468.449369905626}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,Atributo05, \nregexp_replace(\n\tcadena2,'Montaje',DescripcionAlias) as cadena3\nfrom ServicesOpcSKU","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesOpcPrice","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos en la plantilla el precio, cambiando comas por puntos, que es el formato de moneda en magento","uiConfiguration":{"position":{"x":1730.346186982976,"y":466.84113168541114}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio,Atributo05, \nregexp_replace(\n\tcadena3,'8.0000',cast(format_number(cast(regexp_replace(Precio,',','.') as double),2) as String)) as cadena4\nfrom ServicesOpcDescription","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductServicesOpc","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1105.5587920655912,"y":594.1723190857565}},"configuration":{"sql":"select EAN,explode(split(ServiciosOpcionales,\",\")) as product_services\n from ProductosIngestados \n where Categoria='NEUMATICOS'","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProdServicesOpcJOIN","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Unimos filas individuales por servicio del producto con la plantilla que hemos generado del campo servicios opcionales del csv","uiConfiguration":{"position":{"x":2126.903762768716,"y":591.802678020159}},"configuration":{"sql":"select  a.EAN, b.custom_options,b.DescripcionAlias,b.Precio from ProductServicesOpc a\njoin ServicesOpcTime b\n on a.product_services=b.CodInterno\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"UnionServices","stepType":"Transformation","className":"UnionTransformStep","classPrettyName":"Union","arity":["NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Juntamos servicios opcionales y obligatorios","uiConfiguration":{"position":{"x":2360.4259864846285,"y":317.77383151129396}},"configuration":{"inputSchemas":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"Crossdata","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Lectura de las filas de csv ingestadas en postgres correspondientes a productos","uiConfiguration":{"position":{"x":79.23024229280236,"y":329.7358453743268}},"configuration":{"query":"create table if not exists MOTORTOWN.AURGICSVROWS\nUSING com.stratio.crossdata.connector.postgresql  OPTIONS (\n   url '{{{POSTGRES_URL}}}',\n   stratiosecurity 'true',\n   stratiosecuritymode 'tls',\n   driver 'org.postgresql.Driver',\n   dbtable '(select * from {{{MOTORTOWN_SCHEMA}}}.aurgicsvrows where entity=\\'motortown_productos_y_servicios.csv\\') tmp'\n)","tlsEnabled":false,"debugOptions":"{\"query\":\"select * from MOTORTOWN.AURGICSVROWS limit 1\\n\"}"},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"ProductosIngestados","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Lectura de filas ya parseadas de productos, que incluyen tambien los de servicios","uiConfiguration":{"position":{"x":804.7093788021344,"y":330.30497960032255}},"configuration":{"sql":"select * from Csv","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CrossdataStock","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":-298.2757838202872,"y":1561.0658104371819}},"configuration":{"query":"create table if not exists MOTORTOWN.AURGICVSSTOCKROWS\nUSING com.stratio.crossdata.connector.postgresql  OPTIONS (\n   url '{{{POSTGRES_URL}}}',\n   stratiosecurity 'true',\n   stratiosecuritymode 'tls',\n   driver 'org.postgresql.Driver',\n   dbtable '(select * from {{{MOTORTOWN_SCHEMA}}}.aurgicsvrows where entity != \\'motortown_productos_y_servicios.csv\\') tmp'\n)","tlsEnabled":false,"debugOptions":"{\"query\":\"select content from AURGICVSSTOCKROWS limit 1\"}"},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"stock_with_duplicates","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":413.25254434463136,"y":1563.1090046467527}},"configuration":{"sql":"select \n\tProducto as CodInterno,\n\tCentro as id_navision,\n\tcast(Stock as bigint) as stock \nfrom CsvStock\nunion all \nselect\n\tCodInterno,\n\tid_navision,\n\tcast(stock  as bigint) as stock\nfrom PricatJoinProductos\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Disp2H","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":991.6854416497067,"y":1031.0615626506512}},"configuration":{"sql":"select CodInterno, '2 horas' as disponibilidad, 1 as orden_disponibilidad\nfrom\n (\nselect CodInterno,count(id_navision) as cuenta from stock_with_duplicates \n where cast(stock as int) >= 2\ngroup by CodInterno\n ) tmp \n where tmp.cuenta > \n (select (count(*) * 70 / 100)  from \n\t(\n\tselect count(id_navision) from stock_with_duplicates \n\t  where id_navision not in ('20','100001')\n\t group by id_navision\n\t) tmp\n  )","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Disp48H","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1212.680337604064,"y":1250.9329445142978}},"configuration":{"sql":"select CodInterno, '48 horas' as disponibilidad,2 as orden_disponibilidad\n from Not2H\n where CodInterno in \n (select CodInterno from stock_with_duplicates where id_navision='20' and stock > 25)","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"UnionDisponibilidad","stepType":"Transformation","className":"UnionTransformStep","classPrettyName":"Union","arity":["NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1894.9114002610522,"y":1024.3676467351245}},"configuration":{"inputSchemas":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"DispFechaDeterminada","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1429.433857349538,"y":1462.6566030025638}},"configuration":{"sql":"select CodInterno, cast(date_add(current_date(),2) as string) as disponibilidad,3 as orden_disponibilidad\nfrom Not48H\nwhere CodInterno in \n (select CodInterno from stock_with_duplicates where id_navision='100001' and cast(stock as int) > 6)","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"DispAlgunosCentros","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1638.0082312241273,"y":1668.5347417800788}},"configuration":{"sql":"select CodInterno, 'Disponible en algunos centros' as disponibilidad,4 as orden_disponibilidad\nfrom NotFECHA\nwhere CodInterno in \n (\n select CodInterno from\n \t(\n \tselect CodInterno,count(id_navision) as cuenta from stock_with_duplicates \n \twhere cast(stock as int) >= 2\n\tgroup by CodInterno\n \t) sub \n \twhere sub.cuenta > 3\n ) \n ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Csv","stepType":"Transformation","className":"CsvTransformStep","classPrettyName":"Csv","arity":["UnaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"motortown.aurgicsvproductserror","discardTableName":""},"description":"Parseo de fila csv de productos segun header obtenido del archivo de origen proporcionado por aurgi","uiConfiguration":{"position":{"x":550.354789703865,"y":330.1234952890027}},"configuration":{"schema.inputMode":"HEADER","schema.header":"CodInterno;EAN;Matricula;DescripcionAlias;Descripcion02;Bondades;Estado;Categoria;GrupoProducto;ActivoExterno;Atributo01;Atributo02;Atributo03;Atributo04;Atributo05;Atributo06;Atributo07;Atributo08;Atributo09;Atributo10;Atributo11;Atributo12;Atributo13;Atributo14;Atributo15;Atributo16;Precio;linkImgL;linkImgM;linkImgS;PerteneceGrupo01;PerteneceGrupo02;PerteneceGrupo03;PerteneceGrupo04;PerteneceGrupo05;ServiciosObligatorios;ServiciosOpcionales;DeshabilitadoVenta;ActualizarImagen;ActualizarProductos;FamiliaAntigua","delimiterType":"CHARACTER","inputSchemas":"[]","headerRemoval":false,"splitLimit":"-1","whenFieldError":"","whenRowError":"","fieldsPreservationPolicy":"REPLACE","inputField":"content","delimiter":";"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CsvStock","stepType":"Transformation","className":"CsvTransformStep","classPrettyName":"Csv","arity":["UnaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"motortown.aurgicsvstockserror","discardTableName":""},"uiConfiguration":{"position":{"x":157.15577015138092,"y":1561.2515490018372}},"configuration":{"schema.inputMode":"HEADER","schema.header":"Producto;Centro;Stock","delimiterType":"CHARACTER","inputSchemas":"[]","headerRemoval":false,"splitLimit":"-1","whenFieldError":"","whenRowError":"","fieldsPreservationPolicy":"REPLACE","inputField":"content","delimiter":";"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"FixCsv","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Nos quedamos solo las filas csv de la ultima ingesta, y eliminamos el ultimos ; sobrante de cada una","uiConfiguration":{"position":{"x":322.27835106696057,"y":327.17368092399136}},"configuration":{"sql":"select substr(content, 0, length(content)-1)  as content,originalfile from MOTORTOWN.AURGICSVROWS\n where processts = \n \t(select max (processts) from MOTORTOWN.AURGICSVROWS)","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"FixCsvStock","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":-56.22671105451445,"y":1562.303620473922}},"configuration":{"sql":"select content from MOTORTOWN.AURGICVSSTOCKROWS\n where entity in ('motortown_stock_en_plataforma.csv','motortown_stock_por_centro.csv')\n\t and content != 'Producto;Centro;Stock'\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosJoinStock","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Unimos los productos con los campos calculados, con la disponibilidad que calculamos en la parte de stock del flujo, y sustituimos nulos por la cadena usada en Magento para vacíos","uiConfiguration":{"position":{"x":2188.5174081493406,"y":806.3035870282881}},"configuration":{"sql":"select a.*,coalesce(b.disponibilidad,'__EMPTY__VALUE__') as disponibilidad,coalesce(b.orden_disponibilidad,5) as orden_disponibilidad,\ncoalesce(b.availability_date,'__EMPTY__VALUE__') as availability_date from UnionIsMatricula a\nleft join \n\t(select distinct * from AvailabilityDate) b\non a.CodInterno=b.CodInterno","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"DistnictCsvProducts","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"{{{MOTORTOWN_SCHEMA}}}.magentocsvproducts","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":3077.191408994096,"y":1201.4752182228863}},"configuration":{"sql":"select distinct csv,originalfile, current_timestamp as processts\n from MagentoCsvProducts","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesTime","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"ServicesTime2","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos el campo tiempo del servicio obligatorio en la plantilla, que nos llega en campo Atributo05","uiConfiguration":{"position":{"x":1905.5745172696063,"y":190.9043724426379}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio, \nregexp_replace(\n\tcadena4,'time=10',concat('time=',Atributo05)) as custom_options\nfrom ServicesPrice","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ServicesOpcTime","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Sustituimos el campo tiempo del servicio obligatorio en la plantilla, que nos llega en campo Atributo05","uiConfiguration":{"position":{"x":1931.5745477871844,"y":467.10458301392697}},"configuration":{"sql":"select CodInterno,DescripcionAlias,Precio, \nregexp_replace(\n\tcadena4,'time=10',concat('time=',Atributo05)) as custom_options\nfrom ServicesOpcPrice","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Products_OK","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"motortown.products_ok","partitionBy":"","errorTableName":"motortown.aurgiproductserror","discardTableName":"motortown.aurgiproductsko"},"description":"Validacion de productos segun reglas de negocio proporcionadas por aurgi","uiConfiguration":{"position":{"x":804.6215911568339,"y":576.5688496116152}},"configuration":{"sql":"select \n\tCodInterno ,EAN , Matricula , DescripcionAlias , Descripcion02 , Bondades ,\n\tEstado ,Categoria ,GrupoProducto ,ActivoExterno ,Atributo01 ,Atributo02 ,\n\tAtributo04 ,Atributo05 ,Atributo06 ,Atributo07 ,Atributo08 ,Atributo09 ,\n\tAtributo11 ,Atributo12 ,Atributo13 ,Atributo14 ,Atributo15 ,Atributo16 ,\n\tregexp_replace(format_number(cast(regexp_replace(Precio,',','.') as double),2),',','') as Precio ,\n\tServiciosObligatorios ,\n\tServiciosOpcionales,DeshabilitadoVenta,ActualizarImagen,ActualizarProductos,FamiliaAntigua,\n\tcase when ActualizarImagen='True' then linkImgL\n\t\telse '' end as linkImgL,\n\tcase when ActualizarImagen='True' then linkImgM\n\t\telse '' end as linkImgM,\n\tcase when ActualizarImagen='True' then linkImgS\n\t\telse '' end as linkImgS,\n\tcase when Atributo03 in ('CONTINENTAL','PIRELLI','GOOD YEAR','GOOD YEAR','DUNLOP','FIRESTONE'\n\t\t,'BRIDGESTONE','MICHELIN','COOPER','HANKOOK','KUMHO','VREDESTEIN','YOKOHAMA','FALKEN'\n\t\t,'BF GOODRICH','MOTORTOWN','1PRECIO') then Atributo03\n\t\telse '1Precio' end as Atributo03,\n\tsplit(Atributo10,'/')[0] as Atributo10,\n\toriginalfile\n\tfrom ProductosIngestados \n   where Categoria='NEUMATICOS'\n    and GrupoProducto in ('TURISMO','TRAN LIGER','4X4')\n\tand Estado in ('ActivoSalida','Activo','Desactivado')\n\tand Atributo05 in ('0','I','T')\n\tand Atributo06 between 10 and 24\n\tand Atributo07 between 105 and 375 and substr(Atributo07,-1,1)='5'\n\tand Atributo08 between 20 and 95 and Atributo08 % 5 = 0\n\tand Atributo09 in \n\t('A1', 'A2', 'A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'B', 'C', 'D', 'E', 'F' \n\t ,'G','J','K','L','M','N','P','Q','R','S','T','H','V','W','Y')\n\tand split(Atributo10,'/')[0] between 60 and 125\n\tand Atributo11 in ('A', 'B', 'C', 'D', 'E', 'F')\n\tand Atributo12 in ('A', 'B', 'C', 'D', 'E')\n\tand Atributo13 between 60 and 80\n\tand Atributo14 in ('1', '2', '3', '', 'ND', 'NA')\n\tand Atributo15 in ('R', '0')\n\tand Precio is not null \n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Postgres_validation","stepType":"Output","className":"PostgresOutputStep","classPrettyName":"Postgres","arity":["NullaryToNullary","NaryToNullary"],"writer":{"saveMode":"Append"},"uiConfiguration":{"position":{"x":528.8234191597635,"y":784.0693684104433}},"configuration":{"errorSink":true,"url":"{{{Environment.POSTGRES_URL}}}","postgresSaveMode":"STATEMENT","batchsize":"1000","isolationLevel":"READ_UNCOMMITTED","failFast":true,"tlsEnabled":true,"driver":"","schemaFromDatabase":false,"saveOptions":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[]},{"name":"Products_KO","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"{{{MOTORTOWN_SCHEMA}}}.products_ko","partitionBy":"","errorTableName":"{{{MOTORTOWN_SCHEMA}}}.aurgiproductserror","discardTableName":""},"description":"Las filas que no esten validadas en el paso anterior, se escriben en postgres en tabla product_ko","uiConfiguration":{"position":{"x":530.3453978754638,"y":576.3212118308018}},"configuration":{"sql":"select \n\ta.CodInterno, a.Categoria,a.GrupoProducto,a.Estado, \n\ta.Atributo05,a.Atributo06,a.Atributo07,a.Atributo08, a.Atributo09,a.Atributo10,\n\ta.Atributo11,a.Atributo12,a.Atributo13,a.Atributo14,a.Atributo15, current_timestamp as processts\nfrom ProductosIngestados a\n left join Products_OK b\n on b.CodInterno=a.CodInterno\n where b.CodInterno is null \n ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"getEcotasa","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Nos quedamos de los servicios el valor del correspondiente a la ecotasa para posterior uso de manera individual","uiConfiguration":{"position":{"x":2596.123039733411,"y":237.00572714115322}},"configuration":{"sql":"select  EAN, \ncast(format_number(cast(regexp_replace(Precio,',','.') as double),2) as String) as ecotasa_attribute\nfrom UnionServices\n where custom_options like '%ECOTASA%'\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"OptionsJoinsEcotasa","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Juntamos el campo sercivios ya formatado para magento con la ecotasa como campo individual, para usarlo posteriormente como atributo del producto, independiente del campo servicios","uiConfiguration":{"position":{"x":2874.4275258862403,"y":321.1582294026348}},"configuration":{"sql":"select  a.EAN,a.custom_options,b.ecotasa_attribute from CustomOptions a\njoin getEcotasa b\n on a.EAN=b.EAN\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"StockFields","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"motortown.magentocsvstock3","partitionBy":"","errorTableName":"","discardTableName":""},"description":"","uiConfiguration":{"position":{"x":1569.0850511639574,"y":2102.004684256751}},"configuration":{"sql":"Select \ndistinct \nconcat('\"', coalesce(id_navision,''), '\"') as  source_code ,\nconcat('\"', coalesce(CodInterno,''), '\"') as  sku,\nconcat('\"', coalesce(status,''), '\"') as  status ,\nconcat('\"', coalesce(availability,''), '\"') as  availability ,\nconcat('\"', coalesce(availability_order,''), '\"') as  availability_order ,\nconcat('\"', coalesce(availability_date,''), '\"') as  availability_date \nfrom StockAvailabilityDate\n where id_navision not in ('20','100001')","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"MagentoCsvStock","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"{{{MOTORTOWN_SCHEMA}}}.magentocsvstock2","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1935.3370532150702,"y":2102.030622751224}},"configuration":{"sql":"select concat_ws\n(',',\nsource_code ,\nsku ,\nstatus ,\navailability ,\navailability_order ,\navailability_date \n ) as csv, current_timestamp() as processts\n from \n StockFields","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"FixCsvPricat","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":-49.597217606343406,"y":1414.854948785498}},"configuration":{"sql":"select content from MOTORTOWN.AURGICVSSTOCKROWS\n where entity in ('pricat_ctop5.csv')\n\tand content != 'Producto;Centro;Stock'\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CsvPricat","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":156.68586050049225,"y":1414.8548458669527}},"configuration":{"sql":"select split(content,';')[2] as EAN,\n       split(content,';')[71] as STOCK \nfrom FixCsvPricat \nwhere substr(content,1,3) = 'POS'\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"PricatJoinProductos","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":412.8769707678156,"y":1416.3057695818216}},"configuration":{"sql":"select a.CodInterno as CodInterno,'100001' as id_navision, b.STOCK as stock\n from CsvPricat b\n join CurrentEAN a\n \ton a.EAN=b.EAN\n\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosIsMatricula","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Asignamos el valor de isMatricula a partir del campo activo externo","uiConfiguration":{"position":{"x":1614.8956391456632,"y":693.2725837936305}},"configuration":{"sql":"select * , 'Sí' as isMatricula\n from ProductosCalc\n where ActivoExterno='True' and Matricula in \n\t (\n\t \tselect Matricula from \n\t\t(\n\t\t\tselect Matricula, ActivoExterno from ProductosCalc\n\t\t\t where ActivoExterno = 'True'\n\t\t) tmp\n\t\tgroup by Matricula\n\t\thaving count(0) = 1\n\t ) ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"ProductosNotIsMatricula","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Marcamos como No son Matricula todos los productos que no cumplieron criterio anterior","uiConfiguration":{"position":{"x":1615.3959443214444,"y":883.1023567428492}},"configuration":{"sql":"select * , 'No' as isMatricula\n from ProductosCalc\n where CodInterno not in \n ( select CodInterno from ProductosIsMatricula ) ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"UnionIsMatricula","stepType":"Transformation","className":"UnionTransformStep","classPrettyName":"Union","arity":["NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Union de los productos que NO son Matricula con los que SI, para seguir procesandolos en conjunto","uiConfiguration":{"position":{"x":1996.433094664312,"y":807.1343227303253}},"configuration":{"inputSchemas":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"SinStock","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1888.8492625047068,"y":1791.19612706568}},"configuration":{"sql":"select CodInterno, '__EMPTY__VALUE__' as disponibilidad, 5 as orden_disponibilidad\nfrom stock_with_duplicates \nwhere CodInterno not in \n(select CodInterno from DispAlgunosCentros) \nand CodInterno not in \n(select CodInterno from Disp2H) \nand CodInterno not in \n(select CodInterno from Disp48H) \nand CodInterno not in \n(select CodInterno from DispFechaDeterminada) \n\n\n/*\nand CodInterno not in \n(select CodInterno from Disp48H) \nand CodInterno not in\n(select CodInterno from DispFechaDeterminada) */","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"UnionStock","stepType":"Transformation","className":"UnionTransformStep","classPrettyName":"Union","arity":["NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":2188.787799344321,"y":1423.0631164328304}},"configuration":{"inputSchemas":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"AddDisponibilidadMatricula","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":2404.296441675442,"y":807.1357259352607}},"configuration":{"sql":"select a.*,b.orden_disponibilidad_matricula as orden_disponibilidad_matricula,\ncase when b.orden_disponibilidad_matricula=1 then '2 horas'\n\t when b.orden_disponibilidad_matricula=2 then '48 horas'\n\t when b.orden_disponibilidad_matricula=3 then 'Disponible a partir de fecha determinada'\n\t when b.orden_disponibilidad_matricula=4 then 'Disponible en algunos centros'\nelse '__EMPTY__VALUE__' end as disponibilidad_matricula\nfrom ProductosJoinStock a \nleft join\n(\nselect Matricula, min(orden_disponibilidad) as orden_disponibilidad_matricula from ProductosJoinStock\ngroup by Matricula\n) b\non a.Matricula = b.Matricula","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"StockAvailability","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1045.5037879912463,"y":2103.3307875336423}},"configuration":{"sql":"select \nCodInterno,\nid_navision,\n1 as status,\ncase when stock >= 2 then '2 horas'\n\twhen stock < 2 and stock_plataforma > 25 then '48 horas'\n\telse 'Disponible a partir de fecha determinada'\nend as availability,\ncase when stock >= 2 then '1'\n\twhen stock < 2 and stock_plataforma > 25 then '2'\n\telse '3'\nend as availability_order\nfrom stock_join_plataforma\n","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"stock_join_plataforma","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":423.2476234404651,"y":2278.4678114594235}},"configuration":{"sql":"select distinct a.CodInterno as CodInterno,a.id_navision as id_navision,a.stock as stock,coalesce(b.stock_plataforma,0) as stock_plataforma from\n(\n\tselect \n\tProducto as CodInterno,\n\tCentro as id_navision,\n\tcast(Stock as bigint) as stock \n\tfrom CsvStock\n) a\nleft join\n(\n\t select \n\tProducto as CodInterno,\n    Centro as id_navision,\n\tmax(cast(Stock as bigint)) as stock_plataforma\n\tfrom CsvStock\n  \twhere Centro in ('20')\n  \tgroup by Producto,Centro\n\t\n) b\non a.CodInterno=b.CodInterno","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"StockAvailabilityDate","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"stockavailabilitydate","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1268.834646821846,"y":2103.0744738975754}},"configuration":{"sql":"select a.CodInterno,a.id_navision,a.status, a.availability,a.availability_order,\ncase \n\twhen a.availability_order = '1' then cast(current_date() as string)\n\twhen a.availability_order = '2' then cast(date_add(current_date(),2 + b.nfestivos) as string)\n\twhen a.availability_order = '3' then cast(date_add(current_date(),2 + b.nfestivos) as string)\n\telse '__EMPTY__VALUE__'\n end as availability_date\nfrom StockAvailability a\ncross join \n(select count(0)as nfestivos from MOTORTOWN.FESTIVOS \n where to_date(fecha) between current_date() and date_add(current_date(),2)) b","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CrossdataFestivos","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"create table if not exists MOTORTOWN.AURGICVSSTOCKROWS\nUSING com.stratio.crossdata.connector.postgresql  OPTIONS (\n   url 'jdbc:postgresql://poolpostgrestls.marathon.mesos:5432/postgres?prepareThreshold=0',\n   stratiosecurity 'true',\n   stratiosecuritymode 'tls',\n   driver 'org.postgresql.Driver',\n   dbtable '(select * from motortown.aurgicsvrows where entity != \\'motortown_productos_y_servicios.csv\\') tmp'\n)","uiConfiguration":{"position":{"x":1268.985229485567,"y":2259.2388372957444}},"configuration":{"query":"create table if not exists MOTORTOWN.FESTIVOS\nUSING com.stratio.crossdata.connector.postgresql  OPTIONS (\n   url '{{{POSTGRES_URL}}}',\n   stratiosecurity 'true',\n   stratiosecuritymode 'tls',\n   driver 'org.postgresql.Driver',\n   dbtable '{{{MOTORTOWN_SCHEMA}}}.festivos_nacionales'\n) ","tlsEnabled":false,"debugOptions":"{\"query\":\"select * from  MOTORTOWN.FESTIVOS limit 10\"}"},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"AvailabilityDate","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":2189.9214102651094,"y":1034.1292941799552}},"configuration":{"sql":"select a.CodInterno as CodInterno,\n\ta.orden_disponibilidad as orden_disponibilidad,\ncase \n\twhen a.orden_disponibilidad = '3' then cast(date_add(current_date(),2 + b.nfestivos) as string)\n\telse a.disponibilidad\n end as disponibilidad,\t\ncase \n\twhen a.orden_disponibilidad = '1' then cast(current_date() as string)\n\twhen a.orden_disponibilidad = '2' then cast(date_add(current_date(),2 + b.nfestivos) as string)\n\twhen a.orden_disponibilidad = '3' then cast(date_add(current_date(),2 + b.nfestivos) as string)\n\telse '__EMPTY__VALUE__'\n end as availability_date\nfrom UnionStock a\ncross join \n(select count(0)as nfestivos from MOTORTOWN.FESTIVOS \n where to_date(fecha) between current_date() and date_add(current_date(),2)) b","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Postgres_stock_validation","stepType":"Output","className":"PostgresOutputStep","classPrettyName":"Postgres","arity":["NullaryToNullary","NaryToNullary"],"writer":{"saveMode":"Append"},"uiConfiguration":{"position":{"x":651.8817965755443,"y":2141.6114055549597}},"configuration":{"errorSink":true,"url":"{{{Environment.POSTGRES_URL}}}","postgresSaveMode":"STATEMENT","batchsize":"1000","isolationLevel":"READ_UNCOMMITTED","failFast":true,"tlsEnabled":true,"driver":"","schemaFromDatabase":false,"saveOptions":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch","lineageProperties":[]},{"name":"stock_KO","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"{{{MOTORTOWN_SCHEMA}}}.stock_ko","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":420.2939059505443,"y":2140.091263953397}},"configuration":{"sql":"select CodInterno,id_navision,stock as stock \n from stock_with_duplicates\n where stock is null","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CurrentEAN","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":806.9769910637146,"y":960.5968879279326}},"configuration":{"sql":"select CodInterno,EAN from ProductosOrden\n/* union all\nselect CodInterno,EAN from MOTORTOWN.PRODUCTS */","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"CrossdataProducts","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"description":"Lectura de productos ya procesadas en ingestas anteriores  en postgres ","uiConfiguration":{"position":{"x":87.18847788012101,"y":963.6598456916045}},"configuration":{"query":"create table if not exists MOTORTOWN.PRODUCTS\nUSING com.stratio.crossdata.connector.postgresql  OPTIONS (\n   url '{{{POSTGRES_URL}}}',\n   stratiosecurity 'true',\n   stratiosecuritymode 'tls',\n   driver 'org.postgresql.Driver',\n   dbtable '(select * from {{{MOTORTOWN_SCHEMA}}}.products_ok) tmp'\n)\n","tlsEnabled":false,"debugOptions":"{\"query\":\"select * from MOTORTOWN.AURGICSVROWS limit 1\\n\"}"},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData"],"lineageProperties":[]},{"name":"Not48H","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1212.0741144982983,"y":1354.2878880888334}},"configuration":{"sql":"select * from stock_with_duplicates \nwhere CodInterno not in \n(select CodInterno from Disp2H) \nand CodInterno not in \n(select CodInterno from Disp48H) ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"Not2H","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":992.6740052208474,"y":1146.1558937402579}},"configuration":{"sql":"select * from stock_with_duplicates \n where CodInterno not in\n\t(select CodInterno from Disp2H) ","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]},{"name":"NotFECHA","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":"","discardTableName":""},"uiConfiguration":{"position":{"x":1429.437716264666,"y":1582.8123704548589}},"configuration":{"sql":"select * from stock_with_duplicates \nwhere CodInterno not in \n(select CodInterno from Disp2H) \nand CodInterno not in \n(select CodInterno from Disp48H) \nand CodInterno not in\n(select CodInterno from DispFechaDeterminada)","discardConditions":"[]","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch","supportedDataRelations":["ValidData","DiscardedData"],"lineageProperties":[]}],"edges":[{"origin":"ProductsFields","destination":"MagentoCsvProducts","dataType":"ValidData"},{"origin":"ProductosOrden","destination":"ProductosTemporalidad","dataType":"ValidData"},{"origin":"ProductosTemporalidad","destination":"ProductosCalc","dataType":"ValidData"},{"origin":"Services","destination":"ServicesSKU","dataType":"ValidData"},{"origin":"ServicesSKU","destination":"ServicesDescription","dataType":"ValidData"},{"origin":"ServicesDescription","destination":"ServicesPrice","dataType":"ValidData"},{"origin":"ProductServices","destination":"ProdServicesJOIN","dataType":"ValidData"},{"origin":"DistinctServices","destination":"Services","dataType":"ValidData"},{"origin":"Attributes","destination":"AttributesAndOptions","dataType":"ValidData"},{"origin":"AttributesAndOptions","destination":"ProductsFields","dataType":"ValidData"},{"origin":"ServicesOpc","destination":"ServicesOpcSKU","dataType":"ValidData"},{"origin":"ServicesOpcSKU","destination":"ServicesOpcDescription","dataType":"ValidData"},{"origin":"ServicesOpcDescription","destination":"ServicesOpcPrice","dataType":"ValidData"},{"origin":"DistinctServices","destination":"ServicesOpc","dataType":"ValidData"},{"origin":"ProductServicesOpc","destination":"ProdServicesOpcJOIN","dataType":"ValidData"},{"origin":"ProdServicesJOIN","destination":"UnionServices","dataType":"ValidData"},{"origin":"ProdServicesOpcJOIN","destination":"UnionServices","dataType":"ValidData"},{"origin":"UnionServices","destination":"CustomOptions","dataType":"ValidData"},{"origin":"ProductosIngestados","destination":"ProductServices","dataType":"ValidData"},{"origin":"ProductosIngestados","destination":"ProductServicesOpc","dataType":"ValidData"},{"origin":"ProductosIngestados","destination":"DistinctServices","dataType":"ValidData"},{"origin":"Disp2H","destination":"UnionDisponibilidad","dataType":"ValidData"},{"origin":"Disp48H","destination":"UnionDisponibilidad","dataType":"ValidData"},{"origin":"DispFechaDeterminada","destination":"UnionDisponibilidad","dataType":"ValidData"},{"origin":"DispAlgunosCentros","destination":"UnionDisponibilidad","dataType":"ValidData"},{"origin":"Csv","destination":"ProductosIngestados","dataType":"ValidData"},{"origin":"CsvStock","destination":"stock_with_duplicates","dataType":"ValidData"},{"origin":"Crossdata","destination":"FixCsv","dataType":"ValidData"},{"origin":"FixCsv","destination":"Csv","dataType":"ValidData"},{"origin":"CrossdataStock","destination":"FixCsvStock","dataType":"ValidData"},{"origin":"FixCsvStock","destination":"CsvStock","dataType":"ValidData"},{"origin":"MagentoCsvProducts","destination":"DistnictCsvProducts","dataType":"ValidData"},{"origin":"DistnictCsvProducts","destination":"Postgres_1","dataType":"ValidData"},{"origin":"ServicesPrice","destination":"ServicesTime","dataType":"ValidData"},{"origin":"ServicesOpcPrice","destination":"ServicesOpcTime","dataType":"ValidData"},{"origin":"ServicesOpcTime","destination":"ProdServicesOpcJOIN","dataType":"ValidData"},{"origin":"ProductosIngestados","destination":"Products_OK","dataType":"ValidData"},{"origin":"Products_OK","destination":"ProductosOrden","dataType":"ValidData"},{"origin":"Products_KO","destination":"Postgres_validation","dataType":"ValidData"},{"origin":"ProductosIngestados","destination":"Products_KO","dataType":"ValidData"},{"origin":"Products_OK","destination":"Products_KO","dataType":"ValidData"},{"origin":"ServicesTime","destination":"ProdServicesJOIN","dataType":"ValidData"},{"origin":"UnionServices","destination":"getEcotasa","dataType":"ValidData"},{"origin":"CustomOptions","destination":"OptionsJoinsEcotasa","dataType":"ValidData"},{"origin":"getEcotasa","destination":"OptionsJoinsEcotasa","dataType":"ValidData"},{"origin":"OptionsJoinsEcotasa","destination":"AttributesAndOptions","dataType":"ValidData"},{"origin":"StockFields","destination":"MagentoCsvStock","dataType":"ValidData"},{"origin":"MagentoCsvStock","destination":"Postgres_1","dataType":"ValidData"},{"origin":"FixCsvPricat","destination":"CsvPricat","dataType":"ValidData"},{"origin":"CrossdataStock","destination":"FixCsvPricat","dataType":"ValidData"},{"origin":"CsvPricat","destination":"PricatJoinProductos","dataType":"ValidData"},{"origin":"PricatJoinProductos","destination":"stock_with_duplicates","dataType":"ValidData"},{"origin":"ProductosCalc","destination":"ProductosIsMatricula","dataType":"ValidData"},{"origin":"ProductosCalc","destination":"ProductosNotIsMatricula","dataType":"ValidData"},{"origin":"ProductosIsMatricula","destination":"UnionIsMatricula","dataType":"ValidData"},{"origin":"ProductosNotIsMatricula","destination":"UnionIsMatricula","dataType":"ValidData"},{"origin":"UnionIsMatricula","destination":"ProductosJoinStock","dataType":"ValidData"},{"origin":"ProductosIsMatricula","destination":"ProductosNotIsMatricula","dataType":"ValidData"},{"origin":"UnionDisponibilidad","destination":"UnionStock","dataType":"ValidData"},{"origin":"ProductosJoinStock","destination":"AddDisponibilidadMatricula","dataType":"ValidData"},{"origin":"AddDisponibilidadMatricula","destination":"Attributes","dataType":"ValidData"},{"origin":"stock_join_plataforma","destination":"StockAvailability","dataType":"ValidData"},{"origin":"StockAvailability","destination":"StockAvailabilityDate","dataType":"ValidData"},{"origin":"StockAvailabilityDate","destination":"StockFields","dataType":"ValidData"},{"origin":"CrossdataFestivos","destination":"StockAvailabilityDate","dataType":"ValidData"},{"origin":"AvailabilityDate","destination":"ProductosJoinStock","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"stock_KO","dataType":"ValidData"},{"origin":"stock_KO","destination":"Postgres_stock_validation","dataType":"ValidData"},{"origin":"Products_OK","destination":"Postgres_validation","dataType":"ValidData"},{"origin":"ProductosOrden","destination":"CurrentEAN","dataType":"ValidData"},{"origin":"CurrentEAN","destination":"PricatJoinProductos","dataType":"ValidData"},{"origin":"CrossdataProducts","destination":"CurrentEAN","dataType":"ValidData"},{"origin":"CsvStock","destination":"stock_join_plataforma","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"SinStock","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"Disp48H","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"Disp2H","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"Not48H","dataType":"ValidData"},{"origin":"Not48H","destination":"DispFechaDeterminada","dataType":"ValidData"},{"origin":"Disp2H","destination":"Not2H","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"Not2H","dataType":"ValidData"},{"origin":"Not2H","destination":"Disp48H","dataType":"ValidData"},{"origin":"Disp48H","destination":"Not48H","dataType":"ValidData"},{"origin":"DispFechaDeterminada","destination":"NotFECHA","dataType":"ValidData"},{"origin":"stock_with_duplicates","destination":"NotFECHA","dataType":"ValidData"},{"origin":"NotFECHA","destination":"DispAlgunosCentros","dataType":"ValidData"},{"origin":"SinStock","destination":"UnionStock","dataType":"ValidData"},{"origin":"UnionStock","destination":"Postgres_1","dataType":"ValidData"},{"origin":"DispAlgunosCentros","destination":"SinStock","dataType":"ValidData"},{"origin":"UnionStock","destination":"AvailabilityDate","dataType":"ValidData"}]},"executionEngine":"Batch","uiSettings":{"position":{"x":-401.54507959623834,"y":-253.94679860508586,"k":0.3910009265530616}},"lastUpdateDate":"2019-06-27T19:17:31Z","version":24,"group":{"id":"5f7df840-b86c-43d0-b0c7-e1d0f2977bc4","name":"/home/motortown"},"debugMode":false,"versionSparta":"2.6.5-35bdbc7","groupId":"5f7df840-b86c-43d0-b0c7-e1d0f2977bc4"}